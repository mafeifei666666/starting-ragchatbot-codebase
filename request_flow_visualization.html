<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯·æ±‚æµç¨‹å®Œæ•´è¿½è¸ª - Frontend to Backend</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            padding: 2rem;
            margin: 0;
        }
        h1, h2 {
            color: #60a5fa;
            margin-top: 2rem;
        }
        .mermaid {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
        .description {
            background: #1e293b;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #60a5fa;
        }
        .code-section {
            background: #1e293b;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .highlight {
            color: #fbbf24;
            font-weight: bold;
        }
        .step {
            color: #34d399;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: #1e293b;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        th {
            background: #334155;
            color: #60a5fa;
            font-weight: 600;
        }
        .layer {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .layer-frontend { background: #3b82f6; color: white; }
        .layer-api { background: #8b5cf6; color: white; }
        .layer-rag { background: #ec4899; color: white; }
        .layer-ai { background: #f59e0b; color: white; }
        .layer-tools { background: #10b981; color: white; }
        .layer-db { background: #ef4444; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ” å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ªï¼šFrontend â†’ Backend</h1>

    <div class="description">
        <strong>æ¦‚è¿°ï¼š</strong>æœ¬æ–‡æ¡£è¯¦ç»†è¿½è¸ªäº†ä»ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥æŸ¥è¯¢ï¼Œåˆ°åç«¯å¤„ç†å¹¶è¿”å›ç»“æœçš„å®Œæ•´æµç¨‹ã€‚åŒ…æ‹¬æ‰€æœ‰ä¸­é—´æ­¥éª¤ã€å‡½æ•°è°ƒç”¨ã€æ•°æ®ä¼ é€’å’Œå·¥å…·æ‰§è¡Œã€‚
    </div>

    <h2>ğŸ“Š ç³»ç»Ÿæ¶æ„å±‚æ¬¡</h2>
    <div class="mermaid">
        graph TB
            subgraph Frontend["å‰ç«¯å±‚ (Browser)"]
                UI[ç”¨æˆ·ç•Œé¢<br/>index.html]
                JS[è„šæœ¬é€»è¾‘<br/>script.js]
            end

            subgraph API["APIå±‚ (FastAPI)"]
                APP[åº”ç”¨å…¥å£<br/>app.py]
                ENDPOINTS[APIç«¯ç‚¹<br/>/api/query]
            end

            subgraph RAG["RAGç³»ç»Ÿå±‚"]
                RAGS[RAGç³»ç»Ÿ<br/>rag_system.py]
                SESSION[ä¼šè¯ç®¡ç†<br/>session_manager.py]
            end

            subgraph AI["AIç”Ÿæˆå±‚"]
                GEN[AIç”Ÿæˆå™¨<br/>ai_generator.py]
                OPENAI[OpenAI API]
            end

            subgraph Tools["å·¥å…·å±‚"]
                TM[å·¥å…·ç®¡ç†å™¨<br/>ToolManager]
                CST[è¯¾ç¨‹æœç´¢å·¥å…·<br/>CourseSearchTool]
                COT[è¯¾ç¨‹å¤§çº²å·¥å…·<br/>CourseOutlineTool]
            end

            subgraph Data["æ•°æ®å±‚"]
                VS[å‘é‡å­˜å‚¨<br/>VectorStore]
                CHROMA[ChromaDB<br/>å‘é‡æ•°æ®åº“]
            end

            UI --> JS
            JS -->|HTTP POST| ENDPOINTS
            ENDPOINTS --> APP
            APP --> RAGS
            RAGS --> SESSION
            RAGS --> GEN
            GEN --> OPENAI
            OPENAI -->|tool_calls| TM
            TM --> CST
            TM --> COT
            CST --> VS
            COT --> VS
            VS --> CHROMA

            style Frontend fill:#3b82f6,color:#fff
            style API fill:#8b5cf6,color:#fff
            style RAG fill:#ec4899,color:#fff
            style AI fill:#f59e0b,color:#fff
            style Tools fill:#10b981,color:#fff
            style Data fill:#ef4444,color:#fff
    </div>

    <h2>ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹ï¼ˆåºåˆ—å›¾ï¼‰</h2>
    <div class="mermaid">
        sequenceDiagram
            participant User as ğŸ‘¤ ç”¨æˆ·
            participant UI as ğŸ–¥ï¸ å‰ç«¯UI
            participant Script as ğŸ“œ script.js
            participant API as ğŸš€ FastAPI
            participant RAG as ğŸ§  RAGSystem
            participant Session as ğŸ“ SessionManager
            participant AI as ğŸ¤– AIGenerator
            participant OpenAI as â˜ï¸ OpenAI API
            participant ToolMgr as ğŸ”§ ToolManager
            participant Tool as ğŸ› ï¸ SearchTool/OutlineTool
            participant Vector as ğŸ’¾ VectorStore
            participant Chroma as ğŸ—„ï¸ ChromaDB

            User->>UI: 1. è¾“å…¥æŸ¥è¯¢
            UI->>Script: 2. è§¦å‘sendMessage()

            Note over Script: ç¦ç”¨è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»

            Script->>API: 3. POST /api/query<br/>{query, session_id}

            Note over API: app.py: query_documents()

            API->>RAG: 4. rag_system.query(query, session_id)

            RAG->>Session: 5. get_conversation_history(session_id)
            Session-->>RAG: å†å²å¯¹è¯è®°å½•

            RAG->>AI: 6. generate_response(query, history, tools, tool_manager)

            Note over AI: æ„å»ºmessagesæ•°ç»„<br/>åŒ…å«system promptå’Œuser query

            AI->>OpenAI: 7. chat.completions.create(messages, tools)

            Note over OpenAI: AIåˆ†ææŸ¥è¯¢<br/>å†³å®šæ˜¯å¦ä½¿ç”¨å·¥å…·

            alt AIå†³å®šä½¿ç”¨å·¥å…·
                OpenAI-->>AI: 8a. finish_reason="tool_calls"<br/>è¿”å›tool_callè¯·æ±‚

                AI->>ToolMgr: 9. execute_tool(tool_name, **args)

                alt æœç´¢å·¥å…·è°ƒç”¨
                    ToolMgr->>Tool: 10a. CourseSearchTool.execute(query, course_name, lesson_number)
                    Tool->>Vector: 11a. search(query, course_name, lesson_number)
                    Vector->>Chroma: 12a. course_catalog.query() + course_content.query()
                    Chroma-->>Vector: æœç´¢ç»“æœ
                    Vector-->>Tool: SearchResults
                    Tool-->>Tool: _format_results() + ä¿å­˜sources
                    Tool-->>ToolMgr: æ ¼å¼åŒ–çš„æœç´¢ç»“æœ
                else å¤§çº²å·¥å…·è°ƒç”¨
                    ToolMgr->>Tool: 10b. CourseOutlineTool.execute(course_name)
                    Tool->>Vector: 11b. _resolve_course_name() + course_catalog.get()
                    Vector->>Chroma: 12b. è·å–è¯¾ç¨‹å…ƒæ•°æ®
                    Chroma-->>Vector: è¯¾ç¨‹å…ƒæ•°æ®
                    Vector-->>Tool: è¯¾ç¨‹å…ƒæ•°æ®
                    Tool-->>Tool: æ ¼å¼åŒ–å¤§çº² + ä¿å­˜sources
                    Tool-->>ToolMgr: æ ¼å¼åŒ–çš„è¯¾ç¨‹å¤§çº²
                end

                ToolMgr-->>AI: 13. å·¥å…·æ‰§è¡Œç»“æœ

                Note over AI: å°†å·¥å…·ç»“æœæ·»åŠ åˆ°messages<br/>role: "tool"

                AI->>OpenAI: 14. chat.completions.create(messages with tool results)
                OpenAI-->>AI: 15. æœ€ç»ˆç”Ÿæˆçš„å›ç­”
            else AIç›´æ¥å›ç­”
                OpenAI-->>AI: 8b. finish_reason="stop"<br/>ç›´æ¥è¿”å›ç­”æ¡ˆ
            end

            AI-->>RAG: 16. ç”Ÿæˆçš„å›ç­”

            RAG->>ToolMgr: 17. get_last_sources()
            ToolMgr-->>RAG: sourcesåˆ—è¡¨

            RAG->>Session: 18. add_exchange(session_id, query, response)

            RAG-->>API: 19. (response, sources)

            API-->>Script: 20. JSONå“åº”<br/>{answer, sources, session_id}

            Note over Script: ç§»é™¤åŠ è½½åŠ¨ç”»

            Script->>UI: 21. addMessage(answer, 'assistant', sources)

            Note over UI: ä½¿ç”¨marked.parse()æ¸²æŸ“Markdown<br/>æ˜¾ç¤ºsourcesé“¾æ¥

            UI->>User: 22. æ˜¾ç¤ºå›ç­”å’Œæ¥æº
    </div>

    <h2>ğŸ“‹ è¯¦ç»†æ­¥éª¤åˆ†è§£</h2>

    <table>
        <thead>
            <tr>
                <th>æ­¥éª¤</th>
                <th>å±‚çº§</th>
                <th>æ–‡ä»¶:å‡½æ•°</th>
                <th>æ“ä½œ</th>
                <th>æ•°æ®</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td><span class="layer layer-frontend">Frontend</span></td>
                <td>index.html</td>
                <td>ç”¨æˆ·åœ¨è¾“å…¥æ¡†è¾“å…¥æŸ¥è¯¢</td>
                <td>query: string</td>
            </tr>
            <tr>
                <td>2</td>
                <td><span class="layer layer-frontend">Frontend</span></td>
                <td>script.js:sendMessage()</td>
                <td>è·å–æŸ¥è¯¢ï¼Œç¦ç”¨è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»</td>
                <td>query, currentSessionId</td>
            </tr>
            <tr>
                <td>3</td>
                <td><span class="layer layer-frontend">Frontend</span></td>
                <td>script.js:fetch()</td>
                <td>POSTè¯·æ±‚åˆ° /api/query</td>
                <td>{query: string, session_id: string}</td>
            </tr>
            <tr>
                <td>4</td>
                <td><span class="layer layer-api">API</span></td>
                <td>app.py:query_documents()</td>
                <td>æ¥æ”¶è¯·æ±‚ï¼Œåˆ›å»ºsession_idï¼ˆå¦‚æœéœ€è¦ï¼‰</td>
                <td>QueryRequest</td>
            </tr>
            <tr>
                <td>5</td>
                <td><span class="layer layer-rag">RAG</span></td>
                <td>rag_system.py:query()</td>
                <td>æ„å»ºpromptï¼Œè·å–ä¼šè¯å†å²</td>
                <td>query, session_id</td>
            </tr>
            <tr>
                <td>6</td>
                <td><span class="layer layer-rag">RAG</span></td>
                <td>session_manager.py:get_conversation_history()</td>
                <td>è¿”å›å†å²å¯¹è¯è®°å½•ï¼ˆæœ€å¤šMAX_HISTORYæ¡ï¼‰</td>
                <td>formatted history string</td>
            </tr>
            <tr>
                <td>7</td>
                <td><span class="layer layer-ai">AI</span></td>
                <td>ai_generator.py:generate_response()</td>
                <td>æ„å»ºmessagesæ•°ç»„ï¼ˆsystem + userï¼‰</td>
                <td>[{role, content}]</td>
            </tr>
            <tr>
                <td>8</td>
                <td><span class="layer layer-ai">AI</span></td>
                <td>ai_generator.py</td>
                <td>æ·»åŠ toolså‚æ•°ï¼Œtool_choice="auto"</td>
                <td>tools: [tool_definitions]</td>
            </tr>
            <tr>
                <td>9</td>
                <td><span class="layer layer-ai">AI</span></td>
                <td>OpenAI API</td>
                <td>è°ƒç”¨chat.completions.create()</td>
                <td>model, messages, tools, temperature, max_completion_tokens</td>
            </tr>
            <tr>
                <td>10</td>
                <td><span class="layer layer-ai">AI</span></td>
                <td>OpenAI API</td>
                <td>AIåˆ†ææŸ¥è¯¢ï¼Œå†³å®šæ˜¯å¦ä½¿ç”¨å·¥å…·</td>
                <td>finish_reason: "tool_calls" æˆ– "stop"</td>
            </tr>
            <tr>
                <td>11a</td>
                <td><span class="layer layer-ai">AI</span></td>
                <td>ai_generator.py:_handle_tool_execution()</td>
                <td>å¦‚æœfinish_reason=="tool_calls"ï¼Œå¤„ç†å·¥å…·è°ƒç”¨</td>
                <td>tool_calls: [{id, type, function}]</td>
            </tr>
            <tr>
                <td>12</td>
                <td><span class="layer layer-tools">Tools</span></td>
                <td>tool_manager.py:execute_tool()</td>
                <td>æ ¹æ®tool_nameè·¯ç”±åˆ°å¯¹åº”å·¥å…·</td>
                <td>tool_name, **kwargs</td>
            </tr>
            <tr>
                <td>13a</td>
                <td><span class="layer layer-tools">Tools</span></td>
                <td>search_tools.py:CourseSearchTool.execute()</td>
                <td>æ‰§è¡Œè¯¾ç¨‹å†…å®¹æœç´¢</td>
                <td>query, course_name?, lesson_number?</td>
            </tr>
            <tr>
                <td>13b</td>
                <td><span class="layer layer-tools">Tools</span></td>
                <td>search_tools.py:CourseOutlineTool.execute()</td>
                <td>æ‰§è¡Œè¯¾ç¨‹å¤§çº²æŸ¥è¯¢</td>
                <td>course_name</td>
            </tr>
            <tr>
                <td>14</td>
                <td><span class="layer layer-db">Database</span></td>
                <td>vector_store.py:search() æˆ– _resolve_course_name()</td>
                <td>æœç´¢å‘é‡æ•°æ®åº“</td>
                <td>query_texts, n_results, where</td>
            </tr>
            <tr>
                <td>15</td>
                <td><span class="layer layer-db">Database</span></td>
                <td>ChromaDB</td>
                <td>æ‰§è¡Œå‘é‡æœç´¢æˆ–å…ƒæ•°æ®æŸ¥è¯¢</td>
                <td>embeddings, filters</td>
            </tr>
            <tr>
                <td>16</td>
                <td><span class="layer layer-db">Database</span></td>
                <td>ChromaDB â†’ VectorStore</td>
                <td>è¿”å›æœç´¢ç»“æœ</td>
                <td>documents, metadatas, distances</td>
            </tr>
            <tr>
                <td>17</td>
                <td><span class="layer layer-tools">Tools</span></td>
                <td>Tool._format_results()</td>
                <td>æ ¼å¼åŒ–ç»“æœï¼Œä¿å­˜sourcesåˆ°last_sources</td>
                <td>formatted text, sources: [{text, url}]</td>
            </tr>
            <tr>
                <td>18</td>
                <td><span class="layer layer-tools">Tools</span></td>
                <td>Tool â†’ ToolManager</td>
                <td>è¿”å›æ ¼å¼åŒ–çš„å·¥å…·ç»“æœ</td>
                <td>formatted result string</td>
            </tr>
            <tr>
                <td>19</td>
                <td><span class="layer layer-ai">AI</span></td>
                <td>ai_generator.py</td>
                <td>å°†å·¥å…·ç»“æœæ·»åŠ åˆ°messagesï¼Œrole="tool"</td>
                <td>[...messages, {role: "tool", content, tool_call_id}]</td>
            </tr>
            <tr>
                <td>20</td>
                <td><span class="layer layer-ai">AI</span></td>
                <td>OpenAI API</td>
                <td>ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ŒåŸºäºå·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ</td>
                <td>final response</td>
            </tr>
            <tr>
                <td>21</td>
                <td><span class="layer layer-rag">RAG</span></td>
                <td>tool_manager.py:get_last_sources()</td>
                <td>ä»å·¥å…·ä¸­æå–sources</td>
                <td>sources: [{text, url}]</td>
            </tr>
            <tr>
                <td>22</td>
                <td><span class="layer layer-rag">RAG</span></td>
                <td>session_manager.py:add_exchange()</td>
                <td>å°†æœ¬æ¬¡å¯¹è¯æ·»åŠ åˆ°å†å²è®°å½•</td>
                <td>{user: query, assistant: response}</td>
            </tr>
            <tr>
                <td>23</td>
                <td><span class="layer layer-api">API</span></td>
                <td>app.py</td>
                <td>æ„å»ºå“åº”å¯¹è±¡</td>
                <td>QueryResponse(answer, sources, session_id)</td>
            </tr>
            <tr>
                <td>24</td>
                <td><span class="layer layer-api">API</span></td>
                <td>FastAPI</td>
                <td>è¿”å›JSONå“åº”</td>
                <td>{answer: string, sources: array, session_id: string}</td>
            </tr>
            <tr>
                <td>25</td>
                <td><span class="layer layer-frontend">Frontend</span></td>
                <td>script.js</td>
                <td>æ¥æ”¶å“åº”ï¼Œç§»é™¤åŠ è½½åŠ¨ç”»</td>
                <td>data.answer, data.sources</td>
            </tr>
            <tr>
                <td>26</td>
                <td><span class="layer layer-frontend">Frontend</span></td>
                <td>script.js:addMessage()</td>
                <td>ä½¿ç”¨marked.parse()æ¸²æŸ“Markdownï¼Œåˆ›å»ºsourcesåˆ—è¡¨</td>
                <td>HTMLå…ƒç´ </td>
            </tr>
            <tr>
                <td>27</td>
                <td><span class="layer layer-frontend">Frontend</span></td>
                <td>index.html</td>
                <td>åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºå›ç­”å’Œæ¥æº</td>
                <td>DOMæ›´æ–°</td>
            </tr>
        </tbody>
    </table>

    <h2>ğŸ” å·¥å…·è°ƒç”¨æµç¨‹è¯¦è§£</h2>
    <div class="mermaid">
        flowchart TD
            Start([AIæ”¶åˆ°æŸ¥è¯¢]) --> Decision{æŸ¥è¯¢ç±»å‹åˆ†æ}

            Decision -->|è¯¾ç¨‹å¤§çº²ç›¸å…³| OutlineTool[è°ƒç”¨ get_course_outline]
            Decision -->|è¯¾ç¨‹å†…å®¹ç›¸å…³| SearchTool[è°ƒç”¨ search_course_content]
            Decision -->|é€šç”¨çŸ¥è¯†| DirectAnswer[ç›´æ¥å›ç­”ï¼Œä¸ä½¿ç”¨å·¥å…·]

            OutlineTool --> ResolveOutline["è§£æè¯¾ç¨‹åç§°<br/>vector_store._resolve_course_name"]
            ResolveOutline --> GetMetadata["è·å–è¯¾ç¨‹å…ƒæ•°æ®<br/>course_catalog.get"]
            GetMetadata --> FormatOutline["æ ¼å¼åŒ–å¤§çº²<br/>æ ‡é¢˜+è®²å¸ˆ+è¯¾ç¨‹åˆ—è¡¨"]
            FormatOutline --> SaveSourcesOutline["ä¿å­˜sources<br/>last_sources = å¯¹è±¡æ•°ç»„"]
            SaveSourcesOutline --> ReturnOutline["è¿”å›æ ¼å¼åŒ–å¤§çº²"]

            SearchTool --> ResolveSearch{"æœ‰è¯¾ç¨‹åç­›é€‰?"}
            ResolveSearch -->|æ˜¯| ResolveName["è¯­ä¹‰åŒ¹é…è¯¾ç¨‹å<br/>course_catalog.query"]
            ResolveSearch -->|å¦| BuildFilter["æ„å»ºè¿‡æ»¤å™¨"]
            ResolveName --> BuildFilter
            BuildFilter --> VectorSearch["å‘é‡æœç´¢<br/>course_content.query"]
            VectorSearch --> FormatResults["æ ¼å¼åŒ–ç»“æœ<br/>æ·»åŠ è¯¾ç¨‹å’ŒLessonå¤´éƒ¨"]
            FormatResults --> ExtractLinks["æå–è¯¾ç¨‹/è¯¾ç¨‹é“¾æ¥"]
            ExtractLinks --> SaveSourcesSearch["ä¿å­˜sources<br/>last_sources = å¯¹è±¡æ•°ç»„"]
            SaveSourcesSearch --> ReturnResults["è¿”å›æœç´¢ç»“æœ"]

            ReturnOutline --> AddToMessages[æ·»åŠ åˆ°messages<br/>role: tool]
            ReturnResults --> AddToMessages
            DirectAnswer --> FinalResponse[ç”Ÿæˆæœ€ç»ˆå›ç­”]

            AddToMessages --> SecondCall[ç¬¬äºŒæ¬¡OpenAIè°ƒç”¨<br/>åŸºäºå·¥å…·ç»“æœ]
            SecondCall --> FinalResponse

            FinalResponse --> End([è¿”å›ç»™ç”¨æˆ·])

            style OutlineTool fill:#10b981,color:#fff
            style SearchTool fill:#10b981,color:#fff
            style DirectAnswer fill:#f59e0b,color:#fff
            style FinalResponse fill:#60a5fa,color:#fff
    </div>

    <h2>ğŸ’¾ æ•°æ®ç»“æ„æµè½¬</h2>

    <div class="description">
        <h3>1. å‰ç«¯å‘é€çš„æ•°æ®</h3>
        <div class="code-section">
{<br>
&nbsp;&nbsp;"query": "What is the outline of the MCP course?",<br>
&nbsp;&nbsp;"session_id": "abc123" // å¯é€‰ï¼Œé¦–æ¬¡ä¸ºnull<br>
}
        </div>
    </div>

    <div class="description">
        <h3>2. OpenAIå·¥å…·å®šä¹‰</h3>
        <div class="code-section">
{<br>
&nbsp;&nbsp;"type": "function",<br>
&nbsp;&nbsp;"function": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;"name": "search_course_content",<br>
&nbsp;&nbsp;&nbsp;&nbsp;"description": "Search for specific content within course materials",<br>
&nbsp;&nbsp;&nbsp;&nbsp;"parameters": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"type": "object",<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"properties": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"query": {"type": "string", "description": "..."},<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"course_name": {"type": "string", "description": "..."},<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"lesson_number": {"type": "integer", "description": "..."}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"required": ["query"]<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;}<br>
}
        </div>
    </div>

    <div class="description">
        <h3>3. OpenAIè¿”å›çš„tool_calls</h3>
        <div class="code-section">
{<br>
&nbsp;&nbsp;"id": "call_xyz",<br>
&nbsp;&nbsp;"type": "function",<br>
&nbsp;&nbsp;"function": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;"name": "get_course_outline",<br>
&nbsp;&nbsp;&nbsp;&nbsp;"arguments": "{\"course_name\": \"MCP\"}"<br>
&nbsp;&nbsp;}<br>
}
        </div>
    </div>

    <div class="description">
        <h3>4. å·¥å…·è¿”å›çš„ç»“æœ</h3>
        <div class="code-section">
Course: MCP: Build Rich-Context AI Apps with Anthropic<br>
Instructor: Andrew Ng<br>
Course Link: https://...<br>
<br>
Course Outline (11 lessons):<br>
&nbsp;&nbsp;Lesson 0: Introduction<br>
&nbsp;&nbsp;&nbsp;&nbsp;Link: https://...<br>
&nbsp;&nbsp;Lesson 1: Why MCP<br>
&nbsp;&nbsp;&nbsp;&nbsp;Link: https://...<br>
...
        </div>
    </div>

    <div class="description">
        <h3>5. å·¥å…·ä¿å­˜çš„sources</h3>
        <div class="code-section">
[<br>
&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;"text": "MCP: Build Rich-Context AI Apps with Anthropic",<br>
&nbsp;&nbsp;&nbsp;&nbsp;"url": "https://www.deeplearning.ai/short-courses/..."<br>
&nbsp;&nbsp;}<br>
]
        </div>
    </div>

    <div class="description">
        <h3>6. æœ€ç»ˆè¿”å›ç»™å‰ç«¯çš„æ•°æ®</h3>
        <div class="code-section">
{<br>
&nbsp;&nbsp;"answer": "**MCP Course Outline: _MCP: Build Rich-Context AI Apps...**",<br>
&nbsp;&nbsp;"sources": [<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"text": "MCP: Build Rich-Context AI Apps with Anthropic",<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"url": "https://..."<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;],<br>
&nbsp;&nbsp;"session_id": "abc123"<br>
}
        </div>
    </div>

    <h2>ğŸ¯ å…³é”®ä»£ç ä½ç½®</h2>

    <table>
        <thead>
            <tr>
                <th>åŠŸèƒ½</th>
                <th>æ–‡ä»¶</th>
                <th>å‡½æ•°/ç±»</th>
                <th>è¡Œå·</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>å‘é€æŸ¥è¯¢è¯·æ±‚</td>
                <td>frontend/script.js</td>
                <td>sendMessage()</td>
                <td>49-103</td>
            </tr>
            <tr>
                <td>APIç«¯ç‚¹å¤„ç†</td>
                <td>backend/app.py</td>
                <td>query_documents()</td>
                <td>61-79</td>
            </tr>
            <tr>
                <td>RAGæŸ¥è¯¢å…¥å£</td>
                <td>backend/rag_system.py</td>
                <td>query()</td>
                <td>102-140</td>
            </tr>
            <tr>
                <td>AIå“åº”ç”Ÿæˆ</td>
                <td>backend/ai_generator.py</td>
                <td>generate_response()</td>
                <td>43-92</td>
            </tr>
            <tr>
                <td>å·¥å…·è°ƒç”¨å¤„ç†</td>
                <td>backend/ai_generator.py</td>
                <td>_handle_tool_execution()</td>
                <td>94-153</td>
            </tr>
            <tr>
                <td>å·¥å…·æ‰§è¡Œ</td>
                <td>backend/search_tools.py</td>
                <td>ToolManager.execute_tool()</td>
                <td>157-162</td>
            </tr>
            <tr>
                <td>è¯¾ç¨‹æœç´¢</td>
                <td>backend/search_tools.py</td>
                <td>CourseSearchTool.execute()</td>
                <td>55-89</td>
            </tr>
            <tr>
                <td>è¯¾ç¨‹å¤§çº²</td>
                <td>backend/search_tools.py</td>
                <td>CourseOutlineTool.execute()</td>
                <td>161-232</td>
            </tr>
            <tr>
                <td>å‘é‡æœç´¢</td>
                <td>backend/vector_store.py</td>
                <td>VectorStore.search()</td>
                <td>61-100</td>
            </tr>
            <tr>
                <td>è¯¾ç¨‹åè§£æ</td>
                <td>backend/vector_store.py</td>
                <td>_resolve_course_name()</td>
                <td>102-116</td>
            </tr>
            <tr>
                <td>è·å–sources</td>
                <td>backend/search_tools.py</td>
                <td>ToolManager.get_last_sources()</td>
                <td>164-170</td>
            </tr>
            <tr>
                <td>ä¼šè¯å†å²</td>
                <td>backend/session_manager.py</td>
                <td>get_conversation_history()</td>
                <td>-</td>
            </tr>
            <tr>
                <td>å‰ç«¯æ¸²æŸ“</td>
                <td>frontend/script.js</td>
                <td>addMessage()</td>
                <td>120-186</td>
            </tr>
        </tbody>
    </table>

    <h2>âš¡ æ€§èƒ½ä¼˜åŒ–ç‚¹</h2>

    <div class="description">
        <h3>1. ç¼“å­˜å’Œé‡ç”¨</h3>
        <ul>
            <li><strong>SYSTEM_PROMPT</strong>: é™æ€å­˜å‚¨ï¼Œé¿å…æ¯æ¬¡é‡å»º (ai_generator.py:8)</li>
            <li><strong>base_params</strong>: é¢„æ„å»ºAPIå‚æ•° (ai_generator.py:36-41)</li>
            <li><strong>embedding_function</strong>: å…±äº«åµŒå…¥æ¨¡å‹å®ä¾‹ (vector_store.py:46-48)</li>
        </ul>
    </div>

    <div class="description">
        <h3>2. æ‰¹é‡å¤„ç†</h3>
        <ul>
            <li><strong>å¹¶è¡Œå·¥å…·è°ƒç”¨</strong>: OpenAIå¯ä»¥åœ¨ä¸€æ¬¡å“åº”ä¸­è¿”å›å¤šä¸ªtool_calls (ai_generator.py:128)</li>
            <li><strong>æ‰¹é‡å‘é‡æœç´¢</strong>: ChromaDBæ”¯æŒæ‰¹é‡æŸ¥è¯¢ (vector_store.py:93-97)</li>
        </ul>
    </div>

    <div class="description">
        <h3>3. å‡å°‘å¾€è¿”</h3>
        <ul>
            <li><strong>å•æ¬¡APIè°ƒç”¨</strong>: System prompté™åˆ¶"One tool call per query maximum"</li>
            <li><strong>ä¼šè¯ä¿æŒ</strong>: å‰ç«¯ä¿æŒsession_idï¼Œé¿å…æ¯æ¬¡åˆ›å»ºæ–°ä¼šè¯</li>
        </ul>
    </div>

    <h2>ğŸ”’ å®‰å…¨æªæ–½</h2>

    <div class="description">
        <h3>å‰ç«¯å®‰å…¨</h3>
        <ul>
            <li><strong>XSSé˜²æŠ¤</strong>: ä½¿ç”¨escapeHtml()è½¬ä¹‰ç”¨æˆ·è¾“å…¥ (script.js:189-193)</li>
            <li><strong>Markdownå®‰å…¨æ¸²æŸ“</strong>: ä½¿ç”¨marked.parse()å®‰å…¨æ¸²æŸ“ (script.js:127)</li>
            <li><strong>é“¾æ¥å®‰å…¨</strong>: target="_blank" + rel="noopener noreferrer" (script.js:166)</li>
        </ul>
    </div>

    <div class="description">
        <h3>åç«¯å®‰å…¨</h3>
        <ul>
            <li><strong>CORSé…ç½®</strong>: æ˜ç¡®çš„å…è®¸æºåˆ—è¡¨ (app.py:24-32)</li>
            <li><strong>è¾“å…¥éªŒè¯</strong>: Pydanticæ¨¡å‹éªŒè¯ (app.py:38-52)</li>
            <li><strong>é”™è¯¯å¤„ç†</strong>: try-exceptæ•è·å¼‚å¸¸ (app.py:78-79)</li>
            <li><strong>APIå¯†é’¥ä¿æŠ¤</strong>: ä»ç¯å¢ƒå˜é‡è¯»å– (config.py)</li>
        </ul>
    </div>

    <h2>ğŸ› é”™è¯¯å¤„ç†æµç¨‹</h2>
    <div class="mermaid">
        flowchart TD
            Error(["å‘ç”Ÿé”™è¯¯"]) --> Location{"é”™è¯¯ä½ç½®"}

            Location -->|å‰ç«¯| FrontendError["script.js catchå—"]
            Location -->|APIå±‚| APIError["app.py HTTPException"]
            Location -->|RAGå±‚| RAGError["rag_system.py try-except"]
            Location -->|å·¥å…·å±‚| ToolError["Tool.execute è¿”å›é”™è¯¯æ¶ˆæ¯"]
            Location -->|æ•°æ®åº“å±‚| DBError["vector_store.py SearchResults.empty"]

            FrontendError --> RemoveLoading["ç§»é™¤åŠ è½½åŠ¨ç”»"]
            RemoveLoading --> ShowError["æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯"]

            APIError --> HTTPResponse["è¿”å›HTTP 500"]
            HTTPResponse --> FrontendError

            RAGError --> LogError["æ‰“å°é”™è¯¯æ—¥å¿—"]
            LogError --> ReturnError["è¿”å›é”™è¯¯æ¶ˆæ¯"]

            ToolError --> ReturnErrorMsg["è¿”å› Error æ¶ˆæ¯"]

            DBError --> EmptyResults["SearchResults.empty"]
            EmptyResults --> ToolError

            ShowError --> EnableInput["å¯ç”¨è¾“å…¥æ¡†"]
            ReturnError --> APIError
            ReturnErrorMsg --> AIResponse["AIåŸºäºé”™è¯¯æ¶ˆæ¯ç”Ÿæˆå›ç­”"]
            AIResponse --> FrontendError

            style Error fill:#ef4444,color:#fff
            style ShowError fill:#fbbf24,color:#000
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#60a5fa',
                primaryTextColor: '#000',
                primaryBorderColor: '#1e293b',
                lineColor: '#94a3b8',
                secondaryColor: '#34d399',
                tertiaryColor: '#fbbf24'
            },
            flowchart: {
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
